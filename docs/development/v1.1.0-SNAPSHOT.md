# v1.1.0-SNAPSHOT — 基础功能实现

> 对应提交：`3599dde 实现心灵空间基础功能与空间等级系统`

## 功能概览

本版本实现了 MindDomain 模组的全部基础功能：

- 个人维度空间（每个玩家一个独立 `ServerWorld`）
- 空间球物品系统（品质决定初始大小）
- 快捷键进出空间（I / O 键）
- 位置记忆（空间内/外坐标）
- 死亡掉落与空间继承
- 空间等级系统（经验同步、升级扩大）
- 白色屏障方块边界
- 纯白天空渲染
- `/md` 管理员指令

## 架构设计

### 动态维度系统

核心设计：每个玩家的空间是一个完全独立的 `ServerWorld` 实例。

```
玩家使用空间球 → MindDomainState 分配 spaceId
    → DynamicWorldManager 创建 ServerWorld (minddomain:space_<id>)
    → 配置 WorldBorder + barrier 层 + 落脚点
    → 绑定 playerUuid → spaceId
```

**关键类**：
- `DynamicWorldManager`：通过 `MinecraftServerAccessor` Mixin 访问 `MinecraftServer.worlds` 私有字段，将动态创建的 `ServerWorld` 注入服务器维度映射。
- `MindDomainChunkGenerator`：生成纯虚空区块（全空气），落脚点和边界由 `DynamicWorldManager` 事后放置。

### 数据持久化

`MindDomainState` 继承 `PersistentState`，保存在主世界存档文件夹中。

数据结构：
- `nextSpaceId: Int` — 空间 ID 递增分配器
- `spaces: Map<Int, SpaceInfo>` — 空间元数据（大小、等级、经验）
- `playerSpaceMap: Map<UUID, Int>` — 玩家 UUID → 空间绑定
- `playerSpacePositions: Map<UUID, BlockPos>` — 空间内记忆坐标
- `playerReturnPositions: Map<UUID, ReturnPosition>` — 返回位置

### 物品数据组件

空间球使用 1.21 DataComponent 系统：

```kotlin
data class SpaceBallData(
    val size: Int,          // 空间边长（品质）
    val spaceId: Int = -1,  // 关联空间ID（-1=新球）
    val ownerName: String = "" // 原拥有者（死亡掉落时设置）
)
```

### 网络通信

两个 C2S Payload：
- `EnterSpaceC2SPayload`：客户端 I 键 → 服务端进入空间
- `LeaveSpaceC2SPayload`：客户端 O 键 → 服务端离开空间

传送使用 `ServerPlayerEntity.teleportTo(TeleportTarget)`。

### 天空渲染

客户端白色天空效果：
1. `WhiteSkyRenderer`：通过 `WorldRenderEvents.BEFORE` 钩子在心灵空间维度清除帧缓冲为白色
2. 自定义生物群系 `white_void`：`sky_color` / `fog_color` 均为 `0xFFFFFF`

### 空间等级系统

核心流程：

1. `PlayerEntityMixin` 注入 `PlayerEntity.addExperience()`，捕获所有正值经验获取
2. 调用 `ModEvents.onPlayerGainExperience()` 将经验同步到空间
3. `MindDomainState.addSpaceExperience()` 累积经验并处理升级
4. 升级时调用 `DynamicWorldManager.expandSpace()` 更新持久化数据和物理边界

升级公式（`SpaceLevelConfig`）：
- 等级 N → N+1 需要 `100 × N` 经验
- 每升一级空间边长 +2

## Mixin 列表

| Mixin | 目标类 | 用途 |
|-------|--------|------|
| `MinecraftServerAccessor` | `MinecraftServer` | 访问 `worlds` 和 `session` 字段用于动态维度注册 |
| `ItemEntityAccessor` | `ItemEntity` | 访问 `itemAge` 字段用于空间球永不消失机制 |
| `PlayerEntityMixin` | `PlayerEntity` | 注入 `addExperience` 方法，同步经验到空间等级 |

## 已知问题

- 空间球暂无合成配方，需通过指令获取
- 空间内草方块等生物群系染色方块呈现灰白色（非纯白），因为基础纹理为灰度图
