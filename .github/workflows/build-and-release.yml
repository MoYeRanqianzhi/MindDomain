# ============================================================================
# MindDomain CI/CD 工作流
# ============================================================================
# 自动构建与发布工作流：
#   - Tag 推送 (v*): 构建并发布正式版 Release
#     文件名格式: MindDomain-<version>.jar
#   - 分支推送: 构建并发布预发布版 Pre-release
#     文件名格式: MindDomain-<version>+build.<YYYYMMDDHHmmss>.jar
#   - 手动触发 (workflow_dispatch): 指定 tag 补发历史版本
# ============================================================================

name: Build & Release

on:
  push:
    branches: ['**']
    tags: ['v*']
  # 手动触发，用于补发历史版本
  workflow_dispatch:
    inputs:
      tag:
        description: '要构建并发布的 Tag 名称（例如 v1.2.0-SNAPSHOT）'
        required: true
        type: string

# 避免同一分支上的多次推送产生并发构建，取消旧的运行
concurrency:
  group: build-${{ github.event.inputs.tag || github.ref }}
  cancel-in-progress: true

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # ===================== 基础环境准备 =====================

      # 手动触发时 checkout 指定 tag，否则 checkout 当前 ref
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag || github.ref }}
          fetch-depth: 0  # 完整历史，用于生成变更日志

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '9.2.1'

      # ===================== 构建项目 =====================

      - name: Build with Gradle
        run: gradle build

      # ===================== 版本信息提取 =====================

      - name: Extract mod version from gradle.properties
        id: mod
        run: |
          VERSION=$(grep '^mod_version' gradle.properties | cut -d'=' -f2 | tr -d ' ')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Mod version: $VERSION"

      # ===================== 判断发布类型并准备产物 =====================

      - name: Determine release type and prepare artifact
        id: release
        run: |
          SOURCE_JAR="build/libs/MindDomain-${{ steps.mod.outputs.version }}.jar"
          # 手动触发时从 inputs.tag 取值，否则判断 github.ref
          INPUT_TAG="${{ github.event.inputs.tag }}"

          if [[ "${{ github.ref }}" == refs/tags/v* ]] || [[ -n "$INPUT_TAG" ]]; then
            # ---- 正式版：Tag 推送或手动触发 ----
            TAG_NAME="${INPUT_TAG:-${{ github.ref_name }}}"
            ARTIFACT_NAME="MindDomain-${{ steps.mod.outputs.version }}.jar"
            cp "$SOURCE_JAR" "$ARTIFACT_NAME"

            echo "is_release=true" >> "$GITHUB_OUTPUT"
            echo "artifact_name=$ARTIFACT_NAME" >> "$GITHUB_OUTPUT"
            echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"
            echo "release_name=MindDomain ${{ steps.mod.outputs.version }}" >> "$GITHUB_OUTPUT"
            echo "Release type: RELEASE ($ARTIFACT_NAME)"
          else
            # ---- 预发布版：普通提交触发 ----
            TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
            ARTIFACT_NAME="MindDomain-${{ steps.mod.outputs.version }}+build.${TIMESTAMP}.jar"
            cp "$SOURCE_JAR" "$ARTIFACT_NAME"

            echo "is_release=false" >> "$GITHUB_OUTPUT"
            echo "artifact_name=$ARTIFACT_NAME" >> "$GITHUB_OUTPUT"
            echo "tag_name=build-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
            echo "release_name=Pre-release ${{ steps.mod.outputs.version }}+build.${TIMESTAMP}" >> "$GITHUB_OUTPUT"
            echo "timestamp=$TIMESTAMP" >> "$GITHUB_OUTPUT"
            echo "Release type: PRE-RELEASE ($ARTIFACT_NAME)"
          fi

      # ===================== 生成变更日志 =====================

      - name: Generate changelog
        id: changelog
        run: |
          INPUT_TAG="${{ github.event.inputs.tag }}"
          IS_TAG_BUILD=false

          if [[ "${{ github.ref }}" == refs/tags/v* ]] || [[ -n "$INPUT_TAG" ]]; then
            IS_TAG_BUILD=true
            CURRENT_TAG="${INPUT_TAG:-${{ github.ref_name }}}"
          fi

          # 查找上一个正式版 tag（v* 格式），用于生成变更日志范围
          # 如果是 tag 构建，排除当前 tag 自身
          if [ "$IS_TAG_BUILD" = true ]; then
            LAST_TAG=$(git tag -l 'v*' --sort=-v:refname | grep -v "^${CURRENT_TAG}$" | head -n1 2>/dev/null || echo "")
          else
            LAST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -n1 2>/dev/null || echo "")
          fi

          echo "Last release tag: ${LAST_TAG:-'(none)'}"

          if [ -n "$LAST_TAG" ]; then
            LOG=$(git log "${LAST_TAG}..HEAD" --pretty=format:"- %s (\`%h\`)" --no-merges)
          else
            # 没有历史 tag，取最近 30 条提交
            LOG=$(git log --pretty=format:"- %s (\`%h\`)" --no-merges -30)
          fi

          # 使用 EOF 定界符处理多行输出
          {
            echo "log<<EOF"
            echo "$LOG"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # ===================== 上传构建产物（备份） =====================

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.release.outputs.artifact_name }}
          path: ${{ steps.release.outputs.artifact_name }}
          retention-days: 30

      # ===================== 正式版 Release =====================

      - name: Create Release
        if: steps.release.outputs.is_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release.outputs.tag_name }}
          name: ${{ steps.release.outputs.release_name }}
          files: ${{ steps.release.outputs.artifact_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## MindDomain ${{ steps.mod.outputs.version }}

            ### 更新内容

            ${{ steps.changelog.outputs.log }}

            ---
            *完整变更日志见下方 GitHub 自动生成的内容。*
          make_latest: true

      # ===================== 预发布版 Pre-release =====================

      - name: Create Pre-release
        if: steps.release.outputs.is_release == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release.outputs.tag_name }}
          name: ${{ steps.release.outputs.release_name }}
          files: ${{ steps.release.outputs.artifact_name }}
          draft: false
          prerelease: true
          generate_release_notes: false
          body: |
            ## 预发布版 MindDomain ${{ steps.mod.outputs.version }}

            > ⚠️ 此版本为自动构建的预发布版本，可能不稳定，仅供测试使用。

            | 信息 | 值 |
            |------|-----|
            | **分支** | `${{ github.ref_name }}` |
            | **提交** | `${{ github.sha }}` |
            | **构建时间 (UTC)** | `${{ steps.release.outputs.timestamp }}` |

            ### 本次提交

            ${{ github.event.head_commit.message }}

            ### 变更记录

            ${{ steps.changelog.outputs.log }}
          make_latest: false
